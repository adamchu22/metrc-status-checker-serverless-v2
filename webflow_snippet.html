<!-- 
  WEBFLOW INTEGRATION SNIPPET - V5 (URLSearchParams Fix)
  ------------------------------------------------------
  1. Add an "Embed" element to your Webflow page.
  2. Paste this entire code block into the Embed element.
-->

<style>
    :root {
        --metrc-bg: #1a1b1e;
        --metrc-card-bg: #25262b;
        --metrc-text-main: #e9ecef;
        --metrc-text-muted: #909296;
        --metrc-success: #40c057;
        --metrc-warning: #fab005;
        --metrc-error: #fa5252;
        --metrc-border: #2c2e33;
        --metrc-tooltip-bg: #141517;
        --metrc-input-bg: #2c2e33;
    }

    /* Container for the app to isolate styles */
    #metrc-app {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: var(--metrc-text-main);
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Community Alert */
    #metrc-community-alert {
        display: none;
        background: rgba(250, 82, 82, 0.15);
        border: 1px solid var(--metrc-error);
        color: #ff8787;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 30px;
        text-align: center;
        font-weight: 500;
        animation: metrc-pulse 2s infinite;
    }

    @keyframes metrc-pulse {
        0% { box-shadow: 0 0 0 0 rgba(250, 82, 82, 0.2); }
        70% { box-shadow: 0 0 0 10px rgba(250, 82, 82, 0); }
        100% { box-shadow: 0 0 0 0 rgba(250, 82, 82, 0); }
    }

    /* Reporting Section */
    .metrc-report-section {
        background: var(--metrc-card-bg);
        border: 1px solid var(--metrc-border);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 40px;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .metrc-report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        cursor: pointer;
    }
    
    .metrc-report-content {
        display: none;
    }
    .metrc-report-content.open { display: block; }

    .metrc-state-selector {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 8px;
        max-height: 150px;
        overflow-y: auto;
        margin-bottom: 15px;
        padding: 10px;
        background: var(--metrc-input-bg);
        border-radius: 6px;
        border: 1px solid var(--metrc-border);
    }

    .metrc-state-checkbox {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.9rem;
        cursor: pointer;
        color: var(--metrc-text-main);
    }
    
    .metrc-submit-btn {
        width: 100%;
        padding: 12px;
        background: #339af0;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
    }
    .metrc-submit-btn:hover { background: #228be6; }

    /* Dashboard Grid */
    .metrc-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .metrc-card {
        background: var(--metrc-card-bg);
        border: 1px solid var(--metrc-border);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    
    .metrc-card:hover { transform: translateY(-2px); }

    .metrc-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .metrc-state-badge {
        font-size: 1.5rem;
        font-weight: 800;
        color: white;
        background: #339af0;
        padding: 5px 12px;
        border-radius: 8px;
    }

    .metrc-current-status {
        font-weight: bold;
        font-size: 0.9rem;
        padding: 4px 12px;
        border-radius: 20px;
        color: #1a1b1e;
    }
    
    .metrc-user-alert-badge {
        display: inline-block;
        margin-left: 8px;
        font-size: 1.2rem;
        cursor: help;
    }

    /* 7-Day Grid */
    .metrc-history-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        margin-top: 15px;
    }
    
    .metrc-day-box-container {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .metrc-day-label {
        font-size: 0.7rem;
        color: var(--metrc-text-muted);
        margin-bottom: 4px;
    }

    .metrc-day-box {
        width: 100%;
        height: 30px;
        border-radius: 4px;
        background-color: var(--metrc-border);
        cursor: help;
        position: relative;
    }

    .metrc-box-success { background-color: var(--metrc-success); }
    .metrc-box-warning { background-color: var(--metrc-warning); }

    /* Tooltip */
    .metrc-day-box:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--metrc-tooltip-bg);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        white-space: pre-wrap;
        width: max-content;
        max-width: 250px;
        z-index: 100;
        border: 1px solid var(--metrc-border);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        pointer-events: none;
        margin-bottom: 8px;
        text-align: left;
    }

    /* Status Colors */
    .s-ONLINE { background-color: var(--metrc-success); }
    .s-SECURED { background-color: var(--metrc-warning); }
    .s-UNREACHABLE { background-color: var(--metrc-error); color: white; }
    .s-ERROR { background-color: var(--metrc-error); color: white; }
    
    #metrc-last-updated {
        text-align: center;
        color: var(--metrc-text-muted);
        font-size: 0.9rem;
        margin-bottom: 20px;
    }
</style>

<div id="metrc-app">
    <div id="metrc-last-updated">Checking status...</div>

    <!-- Community Alert -->
    <div id="metrc-community-alert">
        ‚ö†Ô∏è <strong>Community Alert:</strong> <span id="metrc-alert-count">0</span> users have reported downtime in the last 3 hours.
    </div>

    <!-- Reporting Section -->
    <div class="metrc-report-section">
        <div class="metrc-report-header" onclick="toggleMetrcReport()">
            <h3 style="margin:0; color: var(--metrc-text-main);">üì¢ Report Downtime</h3>
            <span style="color:var(--metrc-text-muted); font-size: 0.9rem;">Click to expand ‚ñº</span>
        </div>
        <div class="metrc-report-content" id="metrc-report-form-container">
            <p style="font-size: 0.9rem; color: var(--metrc-text-muted); margin-bottom: 15px;">
                Select the affected states. Your report helps others confirm outages.
            </p>
            
            <!-- Hidden iframe removed (using fetch) -->
            
            <form id="metrc-gform" onsubmit="return false;">
                <div class="metrc-state-selector" id="metrc-state-checkboxes"></div>
                <button type="button" class="metrc-submit-btn" id="metrc-submit-btn" onclick="submitMetrcReport()">Submit Report</button>
            </form>
            <div id="metrc-report-msg" style="margin-top:10px; text-align:center; font-size:0.9rem;"></div>
        </div>
    </div>

    <div class="metrc-grid" id="metrc-dashboard"></div>
</div>

<script>
    const METRC_STATES = [
        "AK", "AL", "CA", "CO", "DC", "GU", "IL", "KY", "LA", "MA", 
        "MD", "ME", "MI", "MN", "MO", "MS", "MT", "NV", "NY", "OH", 
        "OK", "OR", "RI", "SD", "VA", "WV"
    ];
    
    // REPLACE THIS with your specific Form Action URL
    const METRC_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSf1x5H9FLTMTgMl1JQZle2avN4Quu5tV-LqqLz_un3qsF1beg/formResponse";
    // REPLACE THIS with your specific Field ID
    const METRC_ENTRY_ID = "entry.1306210022";

    // Populate UI
    const metrcContainer = document.getElementById('metrc-state-checkboxes');
    METRC_STATES.forEach(st => {
        const label = document.createElement('label');
        label.className = 'metrc-state-checkbox';
        label.innerHTML = `<input type="checkbox" value="${st}"> ${st}`;
        metrcContainer.appendChild(label);
    });

    function toggleMetrcReport() {
        document.getElementById('metrc-report-form-container').classList.toggle('open');
    }

    function submitMetrcReport() {
        const checkboxes = document.querySelectorAll('#metrc-state-checkboxes input:checked');
        const checked = Array.from(checkboxes).map(cb => cb.value);
        const msg = document.getElementById('metrc-report-msg');
        
        if (checked.length === 0) {
            msg.style.color = 'var(--metrc-error)';
            msg.innerText = "Please select at least one state.";
            return;
        }

        msg.style.color = 'var(--metrc-text-muted)';
        msg.innerText = "Submitting...";

        // Use URLSearchParams for x-www-form-urlencoded (Better Google Forms compatibility)
        const params = new URLSearchParams();
        checked.forEach(state => {
            params.append(METRC_ENTRY_ID, state);
        });

        // Use fetch with no-cors. 
        // Note: 400 errors usually mean Field ID mismatch or Option mismatch.
        fetch(METRC_FORM_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: params.toString()
        }).then(() => {
            msg.style.color = 'var(--metrc-success)';
            msg.innerText = "Report submitted! Thank you.";
            checkboxes.forEach(cb => cb.checked = false);
        }).catch(err => {
            console.error(err);
            msg.style.color = 'var(--metrc-error)';
            msg.innerText = "Submission failed. Please try again.";
        });
    }

    // --- REMOTE URL FOR WEBFLOW ---
    const METRC_STATUS_URL = 'https://adamchu22.github.io/metrc-status-checker-serverless-v2/status.json';

    async function loadMetrcStatus() {
        try {
            const response = await fetch(METRC_STATUS_URL);
            const history = await response.json();
            
            if (!history || history.length === 0) return;

            const latest = history[history.length - 1];
            document.getElementById('metrc-last-updated').innerText = `Last Updated: ${new Date(latest.timestamp).toLocaleString()}`;

            // Alert Logic
            if (latest.user_reports && latest.user_reports.count > 0) {
                document.getElementById('metrc-community-alert').style.display = 'block';
                document.getElementById('metrc-alert-count').innerText = latest.user_reports.count;
            }

            const grid = document.getElementById('metrc-dashboard');
            grid.innerHTML = '';

            const days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                days.push(d.toISOString().split('T')[0]);
            }

            latest.data.forEach(item => {
                const state = item.state;
                const card = document.createElement('div');
                card.className = 'metrc-card';
                
                // Check if users reported this state
                const userReported = latest.user_reports && 
                                     latest.user_reports.states && 
                                     latest.user_reports.states.includes(state);

                let reportBadge = '';
                if (userReported) {
                    reportBadge = `<span class="metrc-user-alert-badge" title="user(s) reported issues in this state">‚ö†Ô∏è</span>`;
                }

                let historyHTML = '<div class="metrc-history-grid">';
                
                days.forEach(dayKey => {
                    const daySnaps = history.filter(h => h.timestamp.startsWith(dayKey));
                    let hasIncident = false;
                    let incidents = [];
                    let currentIncident = null;

                    const stateSnaps = daySnaps.map(snap => {
                        const rec = snap.data.find(r => r.state === state);
                        return { ts: snap.timestamp, status: rec ? rec.prod_status : 'UNKNOWN' };
                    });

                    stateSnaps.forEach((snap, idx) => {
                        const isDown = snap.status !== 'ONLINE' && snap.status !== 'SECURED' && snap.status !== 'UNKNOWN';
                        if (isDown) {
                            if (!currentIncident) currentIncident = { start: snap.ts, end: null };
                        } else {
                            if (currentIncident) {
                                currentIncident.end = snap.ts;
                                incidents.push(currentIncident);
                                currentIncident = null;
                            }
                        }
                        if (idx === stateSnaps.length - 1 && currentIncident) incidents.push(currentIncident);
                    });

                    if (incidents.length > 0) hasIncident = true;

                    let tooltip = "No incidents";
                    if (hasIncident) {
                        tooltip = incidents.map(inc => {
                            const start = new Date(inc.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            const end = inc.end ? new Date(inc.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "Ongoing";
                            let duration = inc.end ? Math.round((new Date(inc.end) - new Date(inc.start))/60000) + " min" : Math.round((new Date() - new Date(inc.start))/60000) + "+ min";
                            return `Failed: ${start}\nUp: ${end}\nDuration: ${duration}`;
                        }).join('\n\n');
                    } else if (stateSnaps.length === 0) tooltip = "No data";

                    const dateObj = new Date(dayKey);
                    const userDate = new Date(dateObj.valueOf() + dateObj.getTimezoneOffset() * 60000);
                    const dayLabel = userDate.toLocaleDateString('en-US', { weekday: 'short' });
                    const boxClass = hasIncident ? 'metrc-box-warning' : (stateSnaps.length > 0 ? 'metrc-box-success' : '');

                    historyHTML += `
                        <div class="metrc-day-box-container">
                            <span class="metrc-day-label">${dayLabel}</span>
                            <div class="metrc-day-box ${boxClass}" data-tooltip="${tooltip}"></div>
                        </div>
                    `;
                });
                historyHTML += '</div>';

                card.innerHTML = `
                    <div class="metrc-card-header">
                        <div style="display:flex; align-items:center;">
                            <div class="metrc-state-badge">${state}</div>
                            ${reportBadge}
                        </div>
                        <span class="metrc-current-status s-${item.prod_status}">${item.prod_status}</span>
                    </div>
                    ${historyHTML}
                `;
                grid.appendChild(card);
            });

        } catch (error) {
            console.error(error);
            document.getElementById('metrc-last-updated').innerText = "Status unavailable";
        }
    }

    loadMetrcStatus();
</script>